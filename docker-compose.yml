services:
  # The Betaflight Build Environment (from PR #14829)
  bf-builder:
    build: 
      context: .
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - .:/workspace/src        # Firmware Repo
      - ../betaflight-com:/workspace/docs           # Website Repo (adjust path as needed)
      - ./datasheets:/workspace/hardware_docs      # Local PDFs (STM32/AT32)
      - training-data:/data
    working_dir: /workspace/src
    command: sleep infinity
    network_mode: service:ollama # Shared network for speed

  # Local LLM Service (Ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    volumes:
      - ollama_storage:/root/.ollama
    # Enable GPU support (NVIDIA only)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Automatic Model Puller (One-time setup)
  ollama-pull-model:
    image: ollama/ollama:latest
    container_name: ollama-pull-model
    volumes:
      - ollama_storage:/root/.ollama
    entrypoint: /bin/sh
    command: "-c 'ollama serve & sleep 5 && ollama pull deepseek-coder-v2:lite && pkill ollama'"
    depends_on:
      - ollama

  # Your AI Squad
  ai-agents:
    build: ./agents
    volumes:
      - .:/workspace/src        # Firmware Repo
      - ../betaflight-com:/workspace/docs           # Website Repo
      - ./datasheets:/workspace/hardware_docs      # Local PDFs
      - training-data:/data
      - shared_knowledge:/workspace/shared_knowledge  # Shared intelligence
      - /var/run/docker.sock:/var/run/docker.sock # The "Secret Sauce"
    environment:
      - OPENAI_API_BASE=http://ollama:11434/v1 # Point to local Ollama
    depends_on:
      - bf-builder
      - ollama

  # Knowledge Sync (Shared Intelligence)
  knowledge-sync:
    image: alpine:latest
    container_name: knowledge-sync
    volumes:
      - shared_knowledge:/app/db
    command: >
      sh -c "wget -q https://github.com/betaflight/ai-squad/releases/latest/download/vector_db.zip 
      && unzip vector_db.zip -d /app/db || echo 'Vector DB not available yet'"

volumes:
  training-data: # Shared volume for training data
  ollama_storage:
  shared_knowledge: # Shared vector store and datasets